name: C++ Unit Tests (Google Test) for ESP-MESH Component

on:
  push:
    branches: [ main, feature/test-suite, feature/* ]
    paths:
      - 'esphome/components/esp_mesh/**'
      - 'tests/src/**'
      - 'tests/mocks/**'
      - 'tests/CMakeLists.txt'
      - '.github/workflows/cpp-unit-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'esphome/components/esp_mesh/**'
      - 'tests/src/**'

jobs:
  # ============================================
  # JOB 1: NODE Unit Tests
  # ============================================
  unit-tests-node:
    name: "NODE Unit Tests (Core, Networking, Routing)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.27'

      - name: Setup GCC (C++17)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ cmake
          gcc --version
          cmake --version

      - name: Create build directory
        run: mkdir -p build-node

      - name: Configure CMake (NODE Tests)
        working-directory: build-node
        run: |
          cmake ../tests \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-DNODE_MODE=1 -Wall -Wextra -Werror"

      - name: Build NODE tests
        working-directory: build-node
        run: cmake --build . --config Debug -j$(nproc)

      - name: Run NODE Core Tests
        working-directory: build-node
        run: |
          echo "=== NODE Core Tests ==="
          ./esp_mesh_tests --gtest_filter="*SetupTest.*" --gtest_output="xml:test-results-node-core.xml"

      - name: Run NODE Networking Tests
        working-directory: build-node
        run: |
          echo "=== NODE Networking Tests ==="
          ./esp_mesh_tests --gtest_filter="NetworkingTest.*" --gtest_output="xml:test-results-node-networking.xml"

      - name: Run NODE Routing Tests
        working-directory: build-node
        run: |
          echo "=== NODE Routing Tests ==="
          ./esp_mesh_tests --gtest_filter="RoutingTest.*" --gtest_output="xml:test-results-node-routing.xml"

      - name: Upload NODE test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node
          path: build-node/test-results-*.xml
          retention-days: 30

  # ============================================
  # JOB 2: ROOT Unit Tests
  # ============================================
  unit-tests-root:
    name: "ROOT Unit Tests (Peer Management, Validation)"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.27'

      - name: Setup GCC (C++17)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ cmake

      - name: Create build directory
        run: mkdir -p build-root

      - name: Configure CMake (ROOT Tests)
        working-directory: build-root
        run: |
          cmake ../tests \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="-DROOT_MODE=1 -Wall -Wextra -Werror"

      - name: Build ROOT tests
        working-directory: build-root
        run: cmake --build . --config Debug -j$(nproc)

      - name: Run ROOT Peer Management Tests
        working-directory: build-root
        run: |
          echo "=== ROOT Peer Management Tests ==="
          ./esp_mesh_tests --gtest_filter="PeerMgmtTest.*" --gtest_output="xml:test-results-root-peermgmt.xml"

      - name: Run ROOT Validation Tests
        working-directory: build-root
        run: |
          echo "=== ROOT Validation Tests ==="
          ./esp_mesh_tests --gtest_filter="ValidationTest.*" --gtest_output="xml:test-results-root-validation.xml"

      - name: Upload ROOT test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-root
          path: build-root/test-results-*.xml
          retention-days: 30

  # ============================================
  # JOB 3: Coverage Report
  # ============================================
  code-coverage:
    name: "Code Coverage Analysis"
    runs-on: ubuntu-latest
    needs: [unit-tests-node, unit-tests-root]
    if: always()
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ gcov lcov

      - name: Create build directory with coverage
        run: mkdir -p build-coverage

      - name: Configure CMake with coverage
        working-directory: build-coverage
        run: |
          cmake ../tests \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

      - name: Build with coverage
        working-directory: build-coverage
        run: cmake --build . --config Debug -j$(nproc)

      - name: Run all tests
        working-directory: build-coverage
        run: ./esp_mesh_tests

      - name: Collect coverage data
        working-directory: build-coverage
        run: |
          lcov --directory . --capture --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/googletest/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./build-coverage/coverage.info
          flags: unittests
          name: cpp-coverage
          fail_ci_if_error: false

  # ============================================
  # JOB 4: Test Report Summary
  # ============================================
  test-summary:
    name: "Test Results Summary"
    runs-on: ubuntu-latest
    needs: [unit-tests-node, unit-tests-root]
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: 'test-results/**/*.xml'
          check_name: 'C++ Unit Test Results'
          comment_mode: always

      - name: Summary
        run: |
          echo "## âœ… Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### NODE Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Core Setup & Initialization" >> $GITHUB_STEP_SUMMARY
          echo "- Networking Layer" >> $GITHUB_STEP_SUMMARY
          echo "- Routing Layer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ROOT Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Peer Management (LRU, eviction)" >> $GITHUB_STEP_SUMMARY
          echo "- Schema Validation (YAML)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          echo "Code coverage report generated and uploaded to Codecov" >> $GITHUB_STEP_SUMMARY
